# 結合テストガイドライン

## 概要

本ドキュメントには、auraworkシステムの結合テスト（Integration Test）の書き方とガイドラインを記載します。

---

## 1. 結合テストとは

### 1.1 定義
- **対象**: 複数のコンポーネントの連携
- **目的**: コンポーネント間の動作を確認
- **フレームワーク**: PHPUnit with Laravel
- **範囲**: 複数のクラスやモジュール間の相互作用

### 1.2 特徴
- データベースを使用する
- リレーションシップをテスト
- 複数のコンポーネントが連携して動作することを確認
- ビジネスロジックの統合をテスト

---

## 2. 対象コンポーネント

### 2.1 コントローラーとモデルの連携テスト

```php
<?php

namespace Tests\Integration;

use Tests\TestCase;
use App\Models\AccountInfos;
use App\Models\PayrollCalculationDate;
use Illuminate\Foundation\Testing\RefreshDatabase;

class PayrollCalculationIntegrationTest extends TestCase
{
    use RefreshDatabase;

    public function test_payroll_calculation_date_creation_with_account()
    {
        // 従業員の作成
        $accountInfo = AccountInfos::factory()->create([
            'real_name' => '山田太郎',
        ]);
        
        // 給与計算日の作成
        $payrollDate = PayrollCalculationDate::create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
            'salary_start_date' => '2024-01-01',
            'salary_end_date' => '2024-01-31',
            'payment_date' => '2024-02-15',
        ]);
        
        // 確認
        $this->assertDatabaseHas('payroll_calculation_dates', [
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
        ]);
        
        // リレーションの確認
        $this->assertEquals($accountInfo->id, $payrollDate->accountInfo->id);
        $this->assertEquals('山田太郎', $payrollDate->accountInfo->real_name);
    }

    public function test_company_allowance_assignment_flow()
    {
        // 従業員の作成
        $accountInfo = AccountInfos::factory()->create();
        
        // 企業手当の作成
        $allowanceInfo = \App\Models\CompanyAllowanceInfo::factory()->create([
            'company_allowance_name' => '交通費',
        ]);
        
        // 企業手当の付与
        $assignment = \App\Models\CompanyAllowanceAssignment::create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
            'company_allowance_info_id' => $allowanceInfo->id,
            'company_allowance_name' => '交通費',
            'company_allowance_amount' => 10000,
            'allowance_active_flag' => 1,
            'premium_eligible_flag' => 0,
            'deduction_eligible_flag' => 0,
        ]);
        
        // 確認
        $this->assertDatabaseHas('company_allowance_assignments', [
            'account_info_id' => $accountInfo->id,
            'company_allowance_info_id' => $allowanceInfo->id,
        ]);
        
        // リレーションの確認
        $this->assertEquals($accountInfo->id, $assignment->accountInfo->id);
        $this->assertEquals($allowanceInfo->id, $assignment->companyAllowanceInfo->id);
    }
}
```

### 2.2 給与計算フローの統合テスト

```php
<?php

namespace Tests\Integration;

use Tests\TestCase;
use App\Models\AccountInfos;
use App\Models\BasicSalaryInfo;
use App\Models\StandardWorkInfo;
use App\Models\CalculatedHourlyWage;
use Illuminate\Foundation\Testing\RefreshDatabase;

class SalaryCalculationFlowTest extends TestCase
{
    use RefreshDatabase;

    public function test_salary_calculation_flow()
    {
        // 1. 従業員情報の作成
        $accountInfo = AccountInfos::factory()->create([
            'real_name' => '給与太郎',
        ]);
        
        // 2. 基本給情報の登録
        $basicSalary = BasicSalaryInfo::create([
            'account_info_id' => $accountInfo->id,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        // 3. 所定勤務情報の登録
        $standardWork = StandardWorkInfo::create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'daily_work_hours' => 480,
            'annual_work_days' => 250,
            'annual_holiday_days' => 115,
            'monthly_avg_work_days' => 20.83,
            'monthly_avg_work_hours' => 166.67,
        ]);
        
        // 4. 1時間あたりの賃金の計算
        $calculatedWage = CalculatedHourlyWage::create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
            'premium_allowance_amount' => 50000,
            'bonus_hourly_wage_on_monthly_basis' => 1800,
        ]);
        
        // 5. 確認
        $this->assertDatabaseHas('basic_salary_infos', [
            'account_info_id' => $accountInfo->id,
        ]);
        
        $this->assertDatabaseHas('standard_work_infos', [
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
        ]);
        
        $this->assertDatabaseHas('calculated_hourly_wages', [
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
        ]);
        
        // 6. リレーションの確認
        $this->assertEquals(250000, $accountInfo->fresh()->basicSalaryInfo->base_salary);
        $this->assertEquals(20.83, $accountInfo->fresh()->standardWorkInfo->monthly_avg_work_days);
    }
}
```

---

## 3. テストの書き方

### 3.1 データベーステスト

```php
<?php

namespace Tests\Integration;

use Illuminate\Foundation\Testing\RefreshDatabase;

class ExampleTest extends TestCase
{
    use RefreshDatabase; // テスト後にデータベースをリセット

    public function test_multiple_table_interaction()
    {
        // テストデータの作成
        $accountInfo = AccountInfos::factory()->create();
        
        $basicSalary = BasicSalaryInfo::create([
            'account_info_id' => $accountInfo->id,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        // データベースの確認
        $this->assertDatabaseHas('basic_salary_infos', [
            'account_info_id' => $accountInfo->id,
        ]);
        
        // リレーションの確認
        $this->assertEquals($accountInfo->id, $basicSalary->accountInfo->id);
    }
}
```

### 3.2 トランザクションテスト

```php
<?php

namespace Tests\Integration;

use Illuminate\Foundation\Testing\DatabaseTransactions;

class TransactionTest extends TestCase
{
    use DatabaseTransactions; // 自動ロールバック

    public function test_rollback_on_error()
    {
        DB::beginTransaction();
        
        try {
            $accountInfo = AccountInfos::factory()->create();
            throw new \Exception('エラー発生');
        } catch (\Exception $e) {
            DB::rollBack();
        }
        
        // ロールバック後はデータベースにデータが存在しない
        $this->assertDatabaseMissing('account_infos', [
            'real_name' => 'テスト太郎',
        ]);
    }
}
```

---

## 4. リレーションシップのテスト

### 4.1 hasMany リレーション

```php
<?php

namespace Tests\Integration;

use Tests\TestCase;
use App\Models\AccountInfos;
use App\Models\PayrollCalculationDate;

class HasManyRelationTest extends TestCase
{
    use RefreshDatabase;

    public function test_account_info_has_many_payroll_calculation_dates()
    {
        $accountInfo = AccountInfos::factory()->create();
        
        // 複数の給与計算日を作成
        $payrollDate1 = PayrollCalculationDate::factory()->create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
        ]);
        
        $payrollDate2 = PayrollCalculationDate::factory()->create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 2,
        ]);
        
        // リレーションの確認
        $this->assertCount(2, $accountInfo->payrollCalculationDates);
        $this->assertTrue($accountInfo->payrollCalculationDates->contains($payrollDate1));
        $this->assertTrue($accountInfo->payrollCalculationDates->contains($payrollDate2));
    }
}
```

### 4.2 belongsTo リレーション

```php
<?php

namespace Tests\Integration;

use Tests\TestCase;
use App\Models\BasicSalaryInfo;
use App\Models\AccountInfos;

class BelongsToRelationTest extends TestCase
{
    use RefreshDatabase;

    public function test_basic_salary_info_belongs_to_account_info()
    {
        $accountInfo = AccountInfos::factory()->create([
            'real_name' => '太郎',
        ]);
        
        $basicSalary = BasicSalaryInfo::create([
            'account_info_id' => $accountInfo->id,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        // リレーションの確認
        $this->assertEquals($accountInfo->id, $basicSalary->accountInfo->id);
        $this->assertEquals('太郎', $basicSalary->accountInfo->real_name);
    }
}
```

---

## 5. ビジネスロジックの統合テスト

### 5.1 給与計算の統合テスト

```php
<?php

namespace Tests\Integration;

use Tests\TestCase;
use App\Models\AccountInfos;
use App\Models\BasicSalaryInfo;
use App\Models\PremiumRateSetting;
use Illuminate\Foundation\Testing\RefreshDatabase;

class SalaryCalculationLogicTest extends TestCase
{
    use RefreshDatabase;

    public function test_overtime_calculation_flow()
    {
        // 1. 従業員情報
        $accountInfo = AccountInfos::factory()->create();
        
        // 2. 基本給情報
        $basicSalary = BasicSalaryInfo::create([
            'account_info_id' => $accountInfo->id,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        // 3. 割増率設定
        $premiumRate = PremiumRateSetting::create([
            'overtime_premium_rate' => 1.25,
            'night_shift_premium' => 1.35,
        ]);
        
        // 4. 計算ロジック
        $baseWage = $basicSalary->base_salary / 160; // 1時間あたりの賃金
        $overtimeHours = 10; // 時間外時間
        $overtimeAmount = $baseWage * 1.25 * $overtimeHours;
        
        // 5. 確認
        $this->assertGreaterThan(0, $overtimeAmount);
        $this->assertEquals(1.25, $premiumRate->overtime_premium_rate);
    }
}
```

---

## 6. テストの実行

### 6.1 基本コマンド

```bash
# すべての結合テストを実行
php artisan test tests/Integration

# 特定のテストファイルを実行
php artisan test tests/Integration/PayrollCalculationIntegrationTest.php

# 詳細表示
php artisan test -v
```

### 6.2 カバレッジ

```bash
# カバレッジ付きで実行
php artisan test tests/Integration --coverage
```

---

## 7. ベストプラクティス

### 7.1 テストの原則

1. **独立性**: テストは互いに独立していること
2. **データベースのクリーンアップ**: RefreshDatabaseを使用
3. **リアルなデータ**: 可能な限り実際のデータに近いものを使用
4. **エッジケース**: 境界値や異常系もテスト

### 7.2 テスト命名規則

```php
// パターン: test_機能_条件_期待値
public function test_payroll_calculation_with_valid_data_should_succeed()
{
}

public function test_allowance_assignment_flow_with_multiple_records()
{
}
```

### 7.3 テストデータの準備

```php
public function setUp(): void
{
    parent::setUp();
    
    // 共通のテストデータを準備
    $this->accountInfo = AccountInfos::factory()->create();
    $this->basicSalary = BasicSalaryInfo::factory()->create([
        'account_info_id' => $this->accountInfo->id,
    ]);
}
```

---

## 8. よくあるテストパターン

### 8.1 複数テーブル連携テスト

```php
<?php

namespace Tests\Integration;

use Tests\TestCase;
use App\Models\AccountInfos;
use App\Models\BasicSalaryInfo;
use App\Models\StandardWorkInfo;

class MultiTableIntegrationTest extends TestCase
{
    use RefreshDatabase;

    public function test_complete_employee_setup()
    {
        // 1. 従業員の作成
        $accountInfo = AccountInfos::factory()->create();
        
        // 2. 基本給情報の作成
        $basicSalary = BasicSalaryInfo::create([
            'account_info_id' => $accountInfo->id,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        // 3. 所定勤務情報の作成
        $standardWork = StandardWorkInfo::create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'daily_work_hours' => 480,
            'annual_work_days' => 250,
        ]);
        
        // 4. すべてのデータが正しく作成されたことを確認
        $this->assertDatabaseHas('account_infos', ['id' => $accountInfo->id]);
        $this->assertDatabaseHas('basic_salary_infos', ['account_info_id' => $accountInfo->id]);
        $this->assertDatabaseHas('standard_work_infos', ['account_info_id' => $accountInfo->id]);
        
        // 5. リレーションの確認
        $this->assertEquals(1, $accountInfo->basicSalaryInfo->count());
    }
}
```

---

## 9. 参考資料

- [単体テストガイドライン](../50-単体テスト/単体テストガイドライン.md)
- [総合テストガイドライン](../70-総合テスト/総合テストガイドライン.md)
- [Laravel Testing](https://laravel.com/docs/10.x/testing)

---

## 更新履歴

| 日付 | 更新者 | 変更内容 |
|------|--------|----------|
| 2024-12-25 | システム | 初版作成 |

