# 開発ガイドライン

## 概要

本ドキュメントには、auraworkシステムの開発プロセスやガイドラインを記載します。

---

## 1. 開発環境のセットアップ

### 1.1 必要な環境
- **OS**: Windows 10/11
- **PHP**: 8.2以上
- **Composer**: 2.x
- **MySQL**: 8.0以上
- **Node.js**: 18.x以上
- **Git**: 2.x以上

### 1.2 開発ツール
- **IDE**: Visual Studio Code
- **データベース管理**: phpMyAdmin
- **ターミナル**: PowerShell or Git Bash

詳細は [README.md](../../README.md) を参照してください。

---

## 2. Git ワークフロー

### 2.1 ブランチ戦略

#### ブランチの種類
- **main**: 本番環境用ブランチ（保護）
- **develop**: 開発用ブランチ
- **feature**: 機能開発用ブランチ
- **bugfix**: バグ修正用ブランチ
- **hotfix**: 緊急修正用ブランチ

#### ブランチ命名規則
```
feature/機能名
bugfix/修正内容
hotfix/緊急修正
```

#### 例
```
feature/attendance-register
feature/salary-calculation
bugfix/payment-error
hotfix/security-issue
```

### 2.2 コミットメッセージ規約

#### 基本形式
```
<タイプ>: <短い説明>

<詳細説明（オプション）>
```

#### コミットタイプ
| タイプ | 説明 |
|--------|------|
| `feat` | 新機能の追加 |
| `fix` | バグ修正 |
| `docs` | ドキュメントの変更 |
| `style` | コードスタイルの変更（フォーマット等） |
| `refactor` | リファクタリング |
| `test` | テストの追加・修正 |
| `chore` | その他（ビルド、依存関係等） |
| `perf` | パフォーマンス改善 |

#### 例
```bash
# 新機能
feat: 勤怠登録機能を追加

# バグ修正
fix: 給与計算の誤差を修正

# ドキュメント
docs: READMEを更新

# リファクタリング
refactor: コントローラーの処理をサービスに分離
```

### 2.3 プルリクエストの流れ

1. **ブランチ作成**
```bash
git checkout -b feature/新機能名
```

2. **開発・コードフォーマット**
```bash
# コーディング後、Pintでコードをフォーマット
./vendor/bin/pint
```

3. **コミット**
```bash
git add .
git commit -m "feat: 機能追加"
```

4. **GitHubにプッシュ**
```bash
git push origin feature/新機能名
```

5. **プルリクエスト作成**
- GitHubでプルリクエストを作成
- レビュアーを指定
- 変更内容を説明

6. **レビュー・マージ**
- コードレビューを受ける
- 承認後、developブランチにマージ

詳細は [Gitにpushする時.md](../01-gitについて/Gitにpushする時.md) を参照してください。

---

## 3. 開発プロセス

### 3.1 タスクの流れ

1. **要件定義**
   - 要件仕様書の確認
   - 機能仕様の理解

2. **設計**
   - データベース設計
   - 画面設計
   - API設計

3. **実装**
   - コーディング
   - コーディング規約に従う

4. **テスト**
   - 単体テスト
   - 結合テスト
   - 動作確認

5. **レビュー**
   - コードレビュー
   - プルリクエスト

6. **デプロイ**
   - 本番環境へのデプロイ

### 3.2 実装前チェックリスト

- [ ] 要件仕様書を確認した
- [ ] データベース設計を確認した
- [ ] 画面設計を確認した
- [ ] バリデーションルールを確認した
- [ ] 関連する既存コードを確認した

### 3.3 実装後チェックリスト

- [ ] コードフォーマット（Pint）を実行した
- [ ] コーディング規約に従っている
- [ ] バリデーションを実装した
- [ ] エラーハンドリングを実装した
- [ ] ログを出力している
- [ ] テストが通る
- [ ] ドキュメントを更新した

---

## 4. コードレビューの観点

### 4.1 コード品質
- コードフォーマット: Pintでフォーマット済みか
- 可読性: 他者が理解しやすいか
- 保守性: 変更が容易か
- 再利用性: 再利用可能か

### 4.2 セキュリティ
- 入力値検証: バリデーションが適切か
- SQLインジェクション対策: Eloquentを使用しているか
- XSS対策: エスケープ処理を行っているか
- CSRF対策: CSRFトークンを実装しているか

### 4.3 パフォーマンス
- N+1問題: 無駄なクエリがないか
- キャッシュ: キャッシュが活用されているか
- インデックス: データベースにインデックスがあるか

### 4.4 エラーハンドリング
- 例外処理: 適切な例外処理があるか
- ログ: ログが適切に出力されているか
- ユーザーへの通知: エラーメッセージが適切か

---

## 5. コードフォーマット（Pint）

### 5.1 Pintの基本操作

#### コマンド
```bash
# すべてのファイルを自動フォーマット
./vendor/bin/pint

# 変更を確認するだけ（実際には変更しない）
./vendor/bin/pint --test

# 特定のファイルのみフォーマット
./vendor/bin/pint app/Http/Controllers/UserController.php
```

#### 推奨される使用タイミング
- **コミット前**: `./vendor/bin/pint` を実行してからコミット
- **PR作成前**: `./vendor/bin/pint --test` でフォーマットが必要か確認
- **コードレビュー時**: フォーマットの統一を確認

詳細は [Laravel Pintコマンド](../00-コマンドについて/Laravel-Pintコマンド.md) を参照してください。

---

## 6. デバッグ方法

### 6.1 ログの活用

```php
// ログ出力
\Log::info('処理開始', ['param1' => $value1]);
\Log::error('エラー発生', ['error' => $e->getMessage()]);
```

ログファイル: `storage/logs/laravel.log`

### 6.2 デバッグツール
- **dd()**: 変数の内容を表示して処理を停止
- **dump()**: 変数の内容を表示するが処理は継続
- **Log::debug()**: デバッグログを出力

```php
// dd()でデバッグ
dd($request->all());

// dump()でデバッグ
dump($data);

// ログでデバッグ
\Log::debug('デバッグ情報', ['data' => $data]);
```

### 6.3 よくあるエラーと解決方法

#### エラー: Class 'App\Http\Controllers\Xxx' not found
```bash
# キャッシュをクリア
php artisan config:clear
php artisan cache:clear
```

#### エラー: SQLSTATE[HY000] [1045] Access denied
- `.env`ファイルのデータベース設定を確認
- MySQLサーバーが起動しているか確認

#### エラー: 500 Internal Server Error
```bash
# ログを確認
tail -f storage/logs/laravel.log
```

---

## 7. テスト戦略

### 7.1 テストの種類

#### 単体テスト（Unit Test）
- 個別のメソッド・関数をテスト
- PHPUnitを使用

```php
<?php

namespace Tests\Unit;

use Tests\TestCase;
use App\Models\AccountInfos;

class AccountInfosTest extends TestCase
{
    public function test_account_info_creation()
    {
        $accountInfo = AccountInfos::factory()->create();
        
        $this->assertDatabaseHas('account_infos', [
            'id' => $accountInfo->id,
        ]);
    }
}
```

#### 機能テスト（Feature Test）
- 機能全体の動作をテスト
- リクエストからレスポンスまで

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;

class AttendanceRegisterTest extends TestCase
{
    use RefreshDatabase;

    public function test_attendance_register_page_loads()
    {
        $response = $this->get('/attendance/register');
        
        $response->assertStatus(200);
    }
}
```

### 7.2 テストの実行

```bash
# すべてのテストを実行
php artisan test

# 特定のテストクラスを実行
php artisan test Tests/Unit/AccountInfosTest

# カバレッジ付きで実行
php artisan test --coverage
```

---

## 8. データベース管理

### 8.1 マイグレーション

#### マイグレーションファイルの作成
```bash
# マイグレーション作成
php artisan make:migration create_example_table

# モデルとマイグレーションを同時作成
php artisan make:model Example -m
```

#### マイグレーションの実行
```bash
# マイグレーション実行
php artisan migrate

# ロールバック
php artisan migrate:rollback

# ロールバック（ステップ指定）
php artisan migrate:rollback --step=1
```

#### 例: マイグレーションファイル
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up()
    {
        Schema::create('examples', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('examples');
    }
};
```

### 8.2 シーダー

#### シーダーファイルの作成
```bash
php artisan make:seeder ExampleSeeder
```

#### シーダーの実行
```bash
# 特定のシーダーを実行
php artisan db:seed --class=ExampleSeeder

# すべてのシーダーを実行
php artisan db:seed
```

---

## 9. パフォーマンス最適化

### 9.1 データベースクエリの最適化

#### N+1問題の解決
```php
// 悪い例
$employees = AccountInfos::all();
foreach ($employees as $employee) {
    echo $employee->payrollCalculationDates->count();
}

// 良い例
$employees = AccountInfos::with('payrollCalculationDates')->get();
```

#### インデックスの活用
```php
// マイグレーションでインデックスを追加
$table->index('account_info_id');
$table->index(['payroll_year', 'payroll_month']);
```

### 9.2 キャッシュの活用

```php
// キャッシュの使用
$data = Cache::remember('key', 3600, function () {
    return DB::table('account_infos')->get();
});

// キャッシュのクリア
Cache::forget('key');
```

---

## 10. デプロイ手順

### 10.1 本番環境へのデプロイ

1. **コードの準備**
```bash
# developブランチから最新を取得
git checkout develop
git pull origin develop
```

2. **テストの実行**
```bash
php artisan test
```

3. **本番環境へデプロイ**
```bash
# SSHでサーバーに接続
ssh user@server

# リポジトリを更新
cd /path/to/project
git pull origin main

# 依存関係の更新
composer install --no-dev --optimize-autoloader

# マイグレーション実行
php artisan migrate --force

# キャッシュクリア
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

---

## 11. 参考資料

- [README.md](../../README.md)
- [コーディング規約.md](コーディング規約.md)
- [Laravel公式ドキュメント](https://laravel.com/docs/10.x)

---

## 更新履歴

| 日付 | 更新者 | 変更内容 |
|------|--------|----------|
| 2024-12-25 | システム | 初版作成 |

