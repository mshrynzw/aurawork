# 単体テストガイドライン

## 概要

本ドキュメントには、auraworkシステムの単体テスト（Unit Test）の書き方とガイドラインを記載します。

---

## 1. 単体テストとは

### 1.1 定義
- **対象**: 個別のメソッド、関数
- **目的**: 各コンポーネントが正しく動作することを確認
- **フレームワーク**: PHPUnit
- **範囲**: 1つのクラスやメソッドのみをテスト

### 1.2 特徴
- 外部依存がない（データベース、API等）
- 高速に実行できる
- リソースをあまり使わない
- デバッグが容易

---

## 2. 対象コンポーネント

### 2.1 モデルのテスト

```php
<?php

namespace Tests\Unit;

use Tests\TestCase;
use App\Models\AccountInfos;

class AccountInfosTest extends TestCase
{
    public function test_account_info_creation()
    {
        $accountInfo = AccountInfos::factory()->create([
            'real_name' => 'テスト太郎',
        ]);
        
        $this->assertDatabaseHas('account_infos', [
            'id' => $accountInfo->id,
            'real_name' => 'テスト太郎',
        ]);
    }

    public function test_account_info_update()
    {
        $accountInfo = AccountInfos::factory()->create();
        
        $accountInfo->update(['real_name' => '更新太郎']);
        
        $this->assertDatabaseHas('account_infos', [
            'id' => $accountInfo->id,
            'real_name' => '更新太郎',
        ]);
    }

    public function test_account_info_deletion()
    {
        $accountInfo = AccountInfos::factory()->create();
        $id = $accountInfo->id;
        
        $accountInfo->delete();
        
        $this->assertDatabaseMissing('account_infos', [
            'id' => $id,
        ]);
    }
}
```

### 2.2 バリデーションロジックのテスト

```php
<?php

namespace Tests\Unit;

use Tests\TestCase;
use App\Models\BasicSalaryInfo;

class BasicSalaryInfoTest extends TestCase
{
    public function test_base_salary_is_fillable()
    {
        $salaryInfo = BasicSalaryInfo::factory()->create([
            'account_info_id' => 1,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        $this->assertEquals('monthly', $salaryInfo->salary_type);
        $this->assertEquals(250000, $salaryInfo->base_salary);
    }

    public function test_hourly_wage_is_fillable()
    {
        $salaryInfo = BasicSalaryInfo::factory()->create([
            'account_info_id' => 1,
            'salary_type' => 'hourly',
            'hourly_wage' => 1500,
        ]);
        
        $this->assertEquals('hourly', $salaryInfo->salary_type);
        $this->assertEquals(1500, $salaryInfo->hourly_wage);
    }
}
```

### 2.3 計算ロジックのテスト

```php
<?php

namespace Tests\Unit;

use Tests\TestCase;
use App\Models\CalculatedHourlyWage;

class CalculatedHourlyWageTest extends TestCase
{
    public function test_premium_allowance_calculation()
    {
        $calculatedWage = CalculatedHourlyWage::factory()->create([
            'premium_allowance_amount' => 50000,
            'hourly_wage_on_hourly_basis' => 2000,
        ]);
        
        $this->assertEquals(50000, $calculatedWage->premium_allowance_amount);
        $this->assertEquals(2000, $calculatedWage->hourly_wage_on_hourly_basis);
    }

    public function test_deductible_allowance_calculation()
    {
        $calculatedWage = CalculatedHourlyWage::factory()->create([
            'deductible_allowance_amount' => 30000,
        ]);
        
        $this->assertEquals(30000, $calculatedWage->deductible_allowance_amount);
    }
}
```

---

## 3. テストの書き方

### 3.1 基本的なテストメソッド

```php
<?php

namespace Tests\Unit;

use Tests\TestCase;

class ExampleTest extends TestCase
{
    // setUp: 各テストの実行前に呼ばれる
    public function setUp(): void
    {
        parent::setUp();
        // 初期化処理
    }

    // tearDown: 各テストの実行後に呼ばれる
    public function tearDown(): void
    {
        // クリーンアップ処理
        parent::tearDown();
    }

    public function test_basic_assertion()
    {
        // Arrange（準備）
        $expected = 100;
        
        // Act（実行）
        $actual = 50 + 50;
        
        // Assert（検証）
        $this->assertEquals($expected, $actual);
    }
}
```

### 3.2 アサーションメソッド

#### 基本的なアサーション

```php
// 等しいか
$this->assertEquals($expected, $actual);

// 同じオブジェクトか
$this->assertSame($expected, $actual);

// 同じではない
$this->assertNotSame($expected, $actual);

// true か
$this->assertTrue($condition);

// false か
$this->assertFalse($condition);

// null か
$this->assertNull($value);

// nullではない
$this->assertNotNull($value);

// 空か
$this->assertEmpty($value);

// 空ではない
$this->assertNotEmpty($value);
```

#### データベースアサーション

```php
// データベースに存在するか
$this->assertDatabaseHas('table_name', [
    'column' => 'value',
]);

// データベースに存在しないか
$this->assertDatabaseMissing('table_name', [
    'column' => 'value',
]);

// カウントの確認
$this->assertDatabaseCount('table_name', 5);
```

### 3.3 ファクトリーの使用

```php
// ファクトリーファイルの作成
php artisan make:factory AccountInfosFactory

// テストでの使用
$employee = AccountInfos::factory()->create();

// カスタム属性
$employee = AccountInfos::factory()->create([
    'real_name' => 'カスタム名',
]);

// 複数作成
$employees = AccountInfos::factory()->count(10)->create();
```

---

## 4. リレーションのテスト

### 4.1 リレーションの存在確認

```php
<?php

namespace Tests\Unit;

use Tests\TestCase;
use App\Models\AccountInfos;
use App\Models\PayrollCalculationDate;

class AccountInfosRelationTest extends TestCase
{
    public function test_has_many_payroll_calculation_dates()
    {
        $accountInfo = AccountInfos::factory()->create();
        
        $payrollDate1 = PayrollCalculationDate::factory()->create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
        ]);
        
        $payrollDate2 = PayrollCalculationDate::factory()->create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 2,
        ]);
        
        $this->assertCount(2, $accountInfo->payrollCalculationDates);
    }

    public function test_belongs_to_account_info()
    {
        $accountInfo = AccountInfos::factory()->create();
        
        $payrollDate = PayrollCalculationDate::factory()->create([
            'account_info_id' => $accountInfo->id,
        ]);
        
        $this->assertEquals($accountInfo->id, $payrollDate->accountInfo->id);
    }
}
```

---

## 5. テストの実行

### 5.1 基本コマンド

```bash
# すべての単体テストを実行
php artisan test tests/Unit

# 特定のテストファイルを実行
php artisan test tests/Unit/AccountInfosTest.php

# 特定のメソッドを実行
php artisan test --filter test_account_info_creation
```

### 5.2 テストオプション

```bash
# 詳細表示
php artisan test -v

# カバレッジ付きで実行
php artisan test --coverage

# 特定のタグのみ実行
php artisan test --group=unit
```

---

## 6. テストのベストプラクティス

### 6.1 テストの原則

1. **独立性**: テストは互いに独立していること
2. **再現性**: 何度実行しても同じ結果が得られること
3. **速さ**: テストは速く実行できること
4. **明確性**: テストの意図が明確であること

### 6.2 テスト命名規則

```php
// パターン: test_対象_条件_期待値
public function test_account_info_creation_should_create_new_record()
{
}

public function test_calculate_salary_with_overtime_should_add_premium()
{
}

public function test_validation_with_invalid_data_should_fail()
{
}
```

### 6.3 AAA パターン

```php
public function test_account_info_update()
{
    // Arrange（準備）
    $accountInfo = AccountInfos::factory()->create([
        'real_name' => '元の名前',
    ]);
    $newName = '新しい名前';
    
    // Act（実行）
    $accountInfo->update(['real_name' => $newName]);
    
    // Assert（検証）
    $this->assertEquals($newName, $accountInfo->fresh()->real_name);
}
```

---

## 7. よくあるテストパターン

### 7.1 モデルのCRUDテスト

```php
<?php

namespace Tests\Unit;

use Tests\TestCase;
use App\Models\CompanyAllowanceInfo;

class CompanyAllowanceInfoTest extends TestCase
{
    // Create
    public function test_can_create_company_allowance()
    {
        $allowance = CompanyAllowanceInfo::factory()->create([
            'company_allowance_name' => '交通費',
        ]);
        
        $this->assertDatabaseHas('company_allowance_infos', [
            'id' => $allowance->id,
            'company_allowance_name' => '交通費',
        ]);
    }

    // Read
    public function test_can_find_company_allowance()
    {
        $allowance = CompanyAllowanceInfo::factory()->create();
        
        $found = CompanyAllowanceInfo::find($allowance->id);
        
        $this->assertEquals($allowance->company_allowance_name, $found->company_allowance_name);
    }

    // Update
    public function test_can_update_company_allowance()
    {
        $allowance = CompanyAllowanceInfo::factory()->create();
        
        $allowance->update(['company_allowance_name' => '更新された手当']);
        
        $this->assertEquals('更新された手当', $allowance->fresh()->company_allowance_name);
    }

    // Delete
    public function test_can_delete_company_allowance()
    {
        $allowance = CompanyAllowanceInfo::factory()->create();
        $id = $allowance->id;
        
        $allowance->delete();
        
        $this->assertDatabaseMissing('company_allowance_infos', [
            'id' => $id,
        ]);
    }
}
```

### 7.2 バリデーションテスト

```php
<?php

namespace Tests\Unit;

use Tests\TestCase;
use App\Models\BasicSalaryInfo;

class BasicSalaryInfoValidationTest extends TestCase
{
    public function test_base_salary_is_required_for_monthly()
    {
        $this->expectException(\Exception::class);
        
        BasicSalaryInfo::create([
            'account_info_id' => 1,
            'salary_type' => 'monthly',
            // base_salaryを省略
        ]);
    }

    public function test_hourly_wage_is_required_for_hourly()
    {
        $this->expectException(\Exception::class);
        
        BasicSalaryInfo::create([
            'account_info_id' => 1,
            'salary_type' => 'hourly',
            // hourly_wageを省略
        ]);
    }
}
```

---

## 8. モックの使用

### 8.1 モックとは
- 実際のオブジェクトの代わりに使う偽のオブジェクト
- 外部APIやデータベースに依存しないテスト

### 8.2 例

```php
<?php

namespace Tests\Unit;

use Tests\TestCase;
use Mockery;
use App\Services\SalaryCalculationService;

class SalaryCalculationServiceTest extends TestCase
{
    public function test_calculate_total_salary()
    {
        // モックの作成
        $service = Mockery::mock(SalaryCalculationService::class);
        
        $service->shouldReceive('calculateBaseSalary')
            ->once()
            ->andReturn(250000);
        
        $service->shouldReceive('calculateAllowance')
            ->once()
            ->andReturn(50000);
        
        // テストの実行
        $baseSalary = $service->calculateBaseSalary();
        $allowance = $service->calculateAllowance();
        $total = $baseSalary + $allowance;
        
        $this->assertEquals(300000, $total);
    }
}
```

---

## 9. テストデータの管理

### 9.1 ファクトリーの使用

```php
// ファクトリーファイルの作成
php artisan make:factory AccountInfosFactory

// デフォルト値で作成
$accountInfo = AccountInfos::factory()->create();

// カスタム属性で作成
$accountInfo = AccountInfos::factory()->create([
    'real_name' => 'カスタム名',
]);

// 複数作成
$accounts = AccountInfos::factory()->count(10)->create();

// 状態を使用
$accountInfo = AccountInfos::factory()->inactive()->create();
```

### 9.2 シーダーの使用

```php
<?php

namespace Tests\Unit;

use Illuminate\Foundation\Testing\RefreshDatabase;

class ExampleTest extends TestCase
{
    use RefreshDatabase;
    
    public function setUp(): void
    {
        parent::setUp();
        
        // シーダーの実行
        $this->seed(AccountInfosSeeder::class);
    }

    public function test_example()
    {
        $accountInfo = AccountInfos::first();
        
        $this->assertNotNull($accountInfo);
    }
}
```

---

## 10. 参考資料

- [Laravel Testing](https://laravel.com/docs/10.x/testing)
- [PHPUnit Documentation](https://phpunit.de/documentation.html)
- [結合テストガイドライン](../60-結合テスト/結合テストガイドライン.md)

---

## 更新履歴

| 日付 | 更新者 | 変更内容 |
|------|--------|----------|
| 2024-12-25 | システム | 初版作成 |

