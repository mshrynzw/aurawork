# 総合テストガイドライン

## 概要

本ドキュメントには、auraworkシステムの総合テスト（System Test/Feature Test）の書き方とガイドラインを記載します。

---

## 1. 総合テストとは

### 1.1 定義
- **対象**: 機能全体（HTTPリクエスト～レスポンス）
- **目的**: エンドツーエンドの動作を確認
- **フレームワーク**: PHPUnit with Laravel Testing
- **範囲**: ユーザーが実際に使用する機能の流れをテスト

### 1.2 特徴
- 実際のHTTPリクエストを送信
- レスポンスを検証
- ビュー、リダイレクト、セッションをテスト
- ユーザーシナリオに沿ってテスト

---

## 2. 対象機能

### 2.1 勤怠登録機能のテスト

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\AccountInfos;
use Illuminate\Foundation\Testing\RefreshDatabase;

class AttendanceRegisterTest extends TestCase
{
    use RefreshDatabase;

    public function test_attendance_register_page_loads()
    {
        // 従業員データの準備
        $employees = AccountInfos::factory()->count(5)->create();
        
        // ページにアクセス
        $response = $this->get('/attendance/register');
        
        // 確認
        $response->assertStatus(200);
        $response->assertViewIs('attendance.register.attendance_register');
        $response->assertViewHas('employees');
    }

    public function test_can_fetch_salary_date_via_api()
    {
        // 従業員と給与計算日の準備
        $accountInfo = AccountInfos::factory()->create();
        $payrollDate = \App\Models\PayrollCalculationDate::factory()->create([
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
        ]);
        
        // APIにアクセス
        $response = $this->get('/api/salary-dates/attendance', [
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
        ]);
        
        // 確認
        $response->assertStatus(200);
        $response->assertJsonStructure([
            'salary_start_date',
            'salary_end_date',
            'payment_date',
        ]);
    }
}
```

### 2.2 給与計算機能のテスト

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\AccountInfos;
use Illuminate\Foundation\Testing\RefreshDatabase;

class SalaryCalculationTest extends TestCase
{
    use RefreshDatabase;

    public function test_salary_calculation_page_loads()
    {
        // 従業員の準備
        $accountInfo = AccountInfos::factory()->create();
        
        // ページにアクセス
        $response = $this->get('/salary/calculate/1/2024/1');
        
        // 確認
        $response->assertStatus(200);
        $response->assertViewIs('salary.calculate');
    }

    public function test_salary_results_page_loads()
    {
        // 従業員の準備
        $accountInfo = AccountInfos::factory()->create();
        
        // ページにアクセス
        $response = $this->get('/salary/results/salary_results/1/2024/1');
        
        // 確認
        $response->assertStatus(200);
        $response->assertViewIs('salary.results.salary_results');
    }
}
```

### 2.3 基本給与設定機能のテスト

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\AccountInfos;
use Illuminate\Foundation\Testing\RefreshDatabase;

class BasicSalarySettingTest extends TestCase
{
    use RefreshDatabase;

    public function test_basic_salary_setting_page_loads()
    {
        // 従業員の準備
        $accountInfo = AccountInfos::factory()->create();
        
        // ページにアクセス
        $response = $this->get('/settings/basic-salary/1');
        
        // 確認
        $response->assertStatus(200);
        $response->assertViewIs('settings.basic-salary');
        $response->assertViewHas('employee');
        $response->assertViewHas('allEmployees');
    }

    public function test_can_store_basic_salary_info()
    {
        // 従業員の準備
        $accountInfo = AccountInfos::factory()->create();
        
        // 基本給情報を送信
        $response = $this->post('/settings/basic-salary', [
            'account_info_id' => $accountInfo->id,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        // 確認
        $response->assertStatus(302); // リダイレクト
        $this->assertDatabaseHas('basic_salary_infos', [
            'account_info_id' => $accountInfo->id,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
    }

    public function test_validation_rejects_invalid_data()
    {
        // 無効なデータを送信
        $response = $this->post('/settings/basic-salary', [
            'account_info_id' => 999, // 存在しないID
            'salary_type' => 'invalid', // 無効な値
            'base_salary' => -1000, // 負の値
        ]);
        
        // 確認
        $response->assertStatus(302);
        $response->assertSessionHasErrors([
            'account_info_id',
            'salary_type',
            'base_salary',
        ]);
    }
}
```

---

## 3. テストの書き方

### 3.1 HTTPリクエストのテスト

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\AccountInfos;
use Illuminate\Foundation\Testing\RefreshDatabase;

class HttpRequestTest extends TestCase
{
    use RefreshDatabase;

    public function test_get_request()
    {
        // GETリクエスト
        $response = $this->get('/attendance/register');
        
        // ステータスコードの確認
        $response->assertStatus(200);
    }

    public function test_post_request()
    {
        // POSTリクエスト
        $response = $this->post('/settings/basic-salary', [
            'account_info_id' => 1,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        // リダイレクトの確認
        $response->assertStatus(302);
    }

    public function test_put_request()
    {
        // PUTリクエスト
        $response = $this->put('/api/data/1', [
            'name' => '更新された名前',
        ]);
        
        // ステータスの確認
        $response->assertStatus(200);
    }

    public function test_delete_request()
    {
        // DELETEリクエスト
        $response = $this->delete('/api/data/1');
        
        // ステータスの確認
        $response->assertStatus(200);
    }
}
```

### 3.2 HTTP アサーション

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;

class HttpAssertionTest extends TestCase
{
    public function test_status_code()
    {
        $response = $this->get('/attendance/register');
        
        // ステータスコードの確認
        $response->assertStatus(200);
        $response->assertOk();
    }

    public function test_view()
    {
        $response = $this->get('/attendance/register');
        
        // ビューの確認
        $response->assertViewIs('attendance.register.attendance_register');
    }

    public function test_view_data()
    {
        $response = $this->get('/attendance/register');
        
        // ビューデータの確認
        $response->assertViewHas('employees');
    }

    public function test_redirect()
    {
        $response = $this->post('/settings/basic-salary', [
            'account_info_id' => 1,
        ]);
        
        // リダイレクトの確認
        $response->assertRedirect();
        $response->assertRedirect('/settings/basic-salary/1');
    }

    public function test_json_response()
    {
        $response = $this->get('/api/employee/1');
        
        // JSONレスポンスの確認
        $response->assertStatus(200);
        $response->assertJson([
            'id' => 1,
            'real_name' => 'テスト太郎',
        ]);
    }

    public function test_session()
    {
        $response = $this->post('/settings/basic-salary', [
            'account_info_id' => 1,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        // セッションの確認
        $response->assertSessionHas('success');
    }
}
```

---

## 4. ユーザーシナリオのテスト

### 4.1 完全な給与計算フロー

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\AccountInfos;
use App\Models\BasicSalaryInfo;
use App\Models\StandardWorkInfo;
use Illuminate\Foundation\Testing\RefreshDatabase;

class CompleteSalaryCalculationFlowTest extends TestCase
{
    use RefreshDatabase;

    public function test_complete_salary_calculation_flow()
    {
        // ステップ1: 従業員の作成
        $accountInfo = AccountInfos::factory()->create([
            'real_name' => '給与太郎',
        ]);
        
        // ステップ2: 基本給情報の登録
        $response = $this->post('/settings/basic-salary', [
            'account_info_id' => $accountInfo->id,
            'salary_type' => 'monthly',
            'base_salary' => 250000,
        ]);
        
        $response->assertStatus(302);
        $this->assertDatabaseHas('basic_salary_infos', [
            'account_info_id' => $accountInfo->id,
        ]);
        
        // ステップ3: 給与計算日の設定
        $response = $this->post('/settings/payroll-date/store', [
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
            'salary_start_date' => '2024-01-01',
            'salary_end_date' => '2024-01-31',
            'payment_date' => '2024-02-15',
        ]);
        
        $response->assertStatus(302);
        $this->assertDatabaseHas('payroll_calculation_dates', [
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'payroll_month' => 1,
        ]);
        
        // ステップ4: 所定勤務情報の登録
        $response = $this->post('/api/daily-work-hours', [
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
            'daily_work_hours' => 480,
            'annual_work_days' => 250,
            'annual_holiday_days' => 115,
        ]);
        
        $response->assertStatus(200);
        $this->assertDatabaseHas('standard_work_infos', [
            'account_info_id' => $accountInfo->id,
            'payroll_year' => 2024,
        ]);
        
        // ステップ5: 給与計算ページへのアクセス
        $response = $this->get('/salary/calculate/1/2024/1');
        $response->assertStatus(200);
        $response->assertViewIs('salary.calculate');
    }
}
```

---

## 5. エラーハンドリングのテスト

### 5.1 バリデーションエラー

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;

class ValidationErrorTest extends TestCase
{
    use RefreshDatabase;

    public function test_validation_error_on_invalid_salary()
    {
        $response = $this->post('/settings/basic-salary', [
            'account_info_id' => 1,
            'salary_type' => 'monthly',
            'base_salary' => -1000, // 無効な値
        ]);
        
        $response->assertStatus(302);
        $response->assertSessionHasErrors('base_salary');
    }

    public function test_validation_error_on_missing_required_field()
    {
        $response = $this->post('/settings/basic-salary', [
            // 必須フィールドが不足
        ]);
        
        $response->assertStatus(302);
        $response->assertSessionHasErrors([
            'account_info_id',
            'salary_type',
        ]);
    }
}
```

---

## 6. テストの実行

### 6.1 基本コマンド

```bash
# すべての機能テストを実行
php artisan test tests/Feature

# 特定のテストファイルを実行
php artisan test tests/Feature/AttendanceRegisterTest.php

# 特定のメソッドを実行
php artisan test --filter test_attendance_register_page_loads

# 詳細表示
php artisan test -v
```

### 6.2 カバレッジ

```bash
# カバレッジ付きで実行
php artisan test tests/Feature --coverage
```

---

## 7. ベストプラクティス

### 7.1 テストの原則

1. **ユーザーシナリオ**: 実際のユーザーの操作に近い形でテスト
2. **独立性**: テストは互いに独立していること
3. **データベースのクリーンアップ**: RefreshDatabaseを使用
4. **エッジケース**: 正常系だけでなく異常系もテスト

### 7.2 テスト命名規則

```php
// パターン: test_機能_条件_期待値
public function test_attendance_register_page_loads_successfully()
{
}

public function test_basic_salary_storage_with_valid_data_succeeds()
{
}

public function test_validation_rejects_negative_salary_value()
{
}
```

### 7.3 AAA パターン

```php
public function test_store_attendance_data()
{
    // Arrange（準備）
    $accountInfo = AccountInfos::factory()->create();
    $data = [
        'account_info_id' => $accountInfo->id,
        'workday_ymd' => '2024-01-01',
    ];
    
    // Act（実行）
    $response = $this->post('/api/attendance/store', $data);
    
    // Assert（検証）
    $response->assertStatus(200);
    $this->assertDatabaseHas('attendance_manages', $data);
}
```

---

## 8. よくあるテストパターン

### 8.1 ページアクセステスト

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;

class PageAccessTest extends TestCase
{
    public function test_top_page_loads()
    {
        $response = $this->get('/');
        
        $response->assertStatus(200);
        $response->assertViewIs('top');
    }

    public function test_attendance_register_page_requires_data()
    {
        AccountInfos::factory()->count(3)->create();
        
        $response = $this->get('/attendance/register');
        
        $response->assertStatus(200);
        $response->assertViewHas('employees', function ($employees) {
            return $employees->count() === 3;
        });
    }
}
```

### 8.2 APIエンドポイントテスト

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\AccountInfos;

class ApiEndpointTest extends TestCase
{
    public function test_api_returns_json()
    {
        $accountInfo = AccountInfos::factory()->create();
        
        $response = $this->get('/api/employee/1');
        
        $response->assertStatus(200);
        $response->assertJsonStructure([
            'id',
            'real_name',
        ]);
    }

    public function test_api_returns_404_for_nonexistent_record()
    {
        $response = $this->get('/api/employee/999');
        
        $response->assertStatus(404);
    }
}
```

---

## 9. 参考資料

- [単体テストガイドライン](../50-単体テスト/単体テストガイドライン.md)
- [結合テストガイドライン](../60-結合テスト/結合テストガイドライン.md)
- [Laravel Testing](https://laravel.com/docs/10.x/testing)

---

## 更新履歴

| 日付 | 更新者 | 変更内容 |
|------|--------|----------|
| 2024-12-25 | システム | 初版作成 |

